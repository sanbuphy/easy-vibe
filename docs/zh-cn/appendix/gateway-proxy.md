# åå‘ä»£ç†ä¸ç½‘å…³ï¼šNginx / API Gateway åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®

> ğŸ’¡ **å­¦ä¹ æŒ‡å—**ï¼šåå‘ä»£ç†è§£å†³çš„æ˜¯"æµé‡æ€ä¹ˆåˆ†å‘"ï¼ŒAPI ç½‘å…³è§£å†³çš„æ˜¯"è¯·æ±‚æ€ä¹ˆå¤„ç†"ã€‚æœ¬ç« èŠ‚ä¼šå›´ç»•ä¸€ä¸ªé—®é¢˜å±•å¼€ï¼š**åœ¨é«˜å¹¶å‘çš„äº’è”ç½‘æ¶æ„ä¸­ï¼Œå¦‚ä½•æŠŠæµé‡å®‰å…¨ã€é«˜æ•ˆåœ°é€åˆ°æ­£ç¡®çš„æœåŠ¡ï¼Ÿ**

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå»ºè®®ä½ å…ˆè¡¥ä¸¤å—"åŸºç¡€ç –"ï¼š

- **HTTP åŸºç¡€**ï¼šå¯ä»¥å…ˆé˜…è¯» [Web åŸºç¡€](./web-basics/) çš„ã€ŒHTTP åè®®ã€éƒ¨åˆ†ã€‚
- **æœåŠ¡å™¨éƒ¨ç½²**ï¼šå¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰ [éƒ¨ç½²ç›¸å…³æ¦‚å¿µ](./deployment/)ï¼Œå»ºè®®å…ˆäº†è§£åŸºç¡€ã€‚

---

## 0. å¼•è¨€ï¼šä¸ºä»€ä¹ˆç½‘ç«™è®¿é—®æ…¢äº†ã€æŒ‚äº†ã€è¢«æ”»å‡»äº†ï¼Ÿ

<ReverseProxyDemo />

å¾ˆå¤šäººåœ¨å®é™…æ­å»ºç½‘ç«™æ—¶éƒ½ä¼šé‡åˆ°ç±»ä¼¼çš„æƒ…å†µï¼š

- ç½‘ç«™æµé‡ä¸€é«˜å°±å¡é¡¿ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ï¼›
- æŸå°æœåŠ¡å™¨å®•æœºï¼Œæ•´ä¸ªç½‘ç«™å°±ä¸å¯ç”¨äº†ï¼›
- ç½‘ç«™è¢« DDoS æ”»å‡»ï¼ŒæœåŠ¡å™¨ç›´æ¥è¢«æ‰“å®ï¼›
- åå°ç®¡ç†æ¥å£æš´éœ²åœ¨å¤–ç½‘ï¼Œè¢«é»‘å®¢æ‰«ææ”»å‡»ã€‚

ç›´è§‰ä¸Šï¼Œæˆ‘ä»¬ä¼šä»¥ä¸ºæ˜¯ï¼š**"æœåŠ¡å™¨é…ç½®ä¸å¤Ÿ"**ã€‚
ä½†å¤§å¤šæ•°æ—¶å€™ï¼Œé—®é¢˜å¹¶ä¸åœ¨äºæœåŠ¡å™¨"æ€§èƒ½å·®"ï¼Œè€Œåœ¨äºæˆ‘ä»¬**æ²¡æœ‰æŠŠæµé‡å¤„ç†å¥½**ã€‚

é¢å¯¹è¿™äº›æŒ‘æˆ˜ï¼Œå•çº¯ä¾é "å‡çº§æœåŠ¡å™¨"å·²ç»æ‰è¥Ÿè§è‚˜ã€‚æˆ‘ä»¬éœ€è¦ä¸€å¥—æ›´ç³»ç»Ÿçš„æµé‡ç®¡ç†æ–¹æ³•ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼ŒæŠŠæµé‡å®‰å…¨ã€é«˜æ•ˆåœ°åˆ†å‘åˆ°æ­£ç¡®çš„æœåŠ¡ã€‚è¿™æ­£æ˜¯**åå‘ä»£ç†ä¸ç½‘å…³**è¯•å›¾è§£å†³çš„é—®é¢˜ã€‚

---

## 1. ä»€ä¹ˆæ˜¯"åå‘ä»£ç†"ï¼Ÿï¼ˆå®šä¹‰ + åœºæ™¯ï¼‰

å…ˆç»™ä¸€ä¸ªç®€çŸ­çš„å·¥ä½œå®šä¹‰ï¼Œå†çœ‹å‡ ä¸ªå…¸å‹åœºæ™¯ã€‚

> åå‘ä»£ç†ï¼Œæ˜¯éƒ¨ç½²åœ¨æœåŠ¡å™¨ç«¯çš„"æµé‡ä¸­è½¬ç«™"ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè½¬å‘ç»™å†…éƒ¨æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯åªçŸ¥é“åå‘ä»£ç†çš„å­˜åœ¨ï¼Œä¸çŸ¥é“çœŸå®æœåŠ¡å™¨çš„åœ°å€ã€‚

ä½ å¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£æˆä¸‰ä»¶äº‹ï¼š**æ¥æ”¶è¯·æ±‚ã€è½¬å‘è¯·æ±‚ã€è¿”å›å“åº”**ã€‚
å¸¸è§ä¼šç”¨åˆ°å®ƒçš„åœºæ™¯åŒ…æ‹¬ï¼š

- **è´Ÿè½½å‡è¡¡**ï¼šå°†æµé‡åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨ï¼Œé¿å…å•ç‚¹å‹åŠ›è¿‡å¤§ã€‚
- **å®‰å…¨é˜²æŠ¤**ï¼šéšè—çœŸå®æœåŠ¡å™¨ IPï¼Œé˜²æ­¢ç›´æ¥æ”»å‡»ã€‚
- **SSL ç»ˆç»“**ï¼šåœ¨ç½‘å…³å±‚å¤„ç† HTTPSï¼Œåç«¯æœåŠ¡ä½¿ç”¨ HTTPï¼Œé™ä½è®¡ç®—å¼€é”€ã€‚
- **åŠ¨é™åˆ†ç¦»**ï¼šé™æ€èµ„æºç›´æ¥ç”± Nginx è¿”å›ï¼ŒåŠ¨æ€è¯·æ±‚è½¬å‘ç»™åº”ç”¨æœåŠ¡å™¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»ä¸€ä¸ªçœŸå®å›¢é˜Ÿçš„"è¸©å‘ç»å†"å‡ºå‘ï¼Œçœ‹çœ‹ä»–ä»¬æ˜¯æ€ä¹ˆä¸€ç‚¹ç‚¹ä»"å•æœºéƒ¨ç½²"è¿›åŒ–åˆ°"ç½‘å…³æ¶æ„"çš„ã€‚

---

## 2. ä»"è¡€æ³ªæ•™è®­"è¯´èµ·ï¼šæŸç”µå•†å¤§ä¿ƒè¸©è¿‡çš„å‘

æœ¬ç« æ¡ˆä¾‹æ¥è‡ª **æŸç”µå•†å¹³å°**ï¼ˆæ—¥æ´»åƒä¸‡çº§ç”¨æˆ·ï¼‰ã€‚
ä¸æ™®é€šç½‘ç«™ä¸åŒï¼Œç”µå•†å¹³å°åœ¨åŒåä¸€ç­‰å¤§ä¿ƒæœŸé—´ï¼Œæµé‡ä¼šå‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œå¯¹ç³»ç»Ÿçš„ç¨³å®šæ€§ã€æ€§èƒ½ã€å®‰å…¨æ€§éƒ½æå‡ºäº†æé«˜è¦æ±‚ã€‚

è¿™å¸¦æ¥äº†æ ¸å¿ƒçŸ›ç›¾ï¼š
- **å¦‚æœåªç”¨ä¸€å°æœåŠ¡å™¨**ï¼šæµé‡ä¸€é«˜å°±å®•æœºï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚
- **å¦‚æœç›´æ¥æš´éœ²å¤šå°æœåŠ¡å™¨**ï¼šå®¢æˆ·ç«¯éœ€è¦çŸ¥é“å¤šä¸ª IPï¼Œæ— æ³•å®ç°è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”å®‰å…¨æ€§æå·®ã€‚

è¯¥å¹³å°çš„æŠ€æœ¯å›¢é˜Ÿç»å†è¿‡å¤šæ¬¡æ¶æ„é‡æ„ï¼Œæ‰æ˜ç™½ä¸€ä¸ªé“ç†ï¼š**æµé‡ä¸èƒ½åªé "æŒ¡"ï¼Œè€Œè¦é "ç–"å’Œ"å¯¼"ã€‚**

### 2.1 å››æ¬¡é‡æ„æ•™ä¼šæˆ‘ä»¬ä»€ä¹ˆï¼Ÿ

è¯¥å¹³å°çš„ CTO åœ¨æ¶æ„åˆ†äº«ä¼šä¸Šè®²è¿‡ä¸€ä¸ª"è¸©å‘å²"ï¼š

| é˜¶æ®µ | é‡åˆ°çš„é—®é¢˜ | å½“æ—¶çš„æƒ³æ³• | ç»“æœ |
| :--- | :--- | :--- | :--- |
| **ç¬¬ä¸€æ¬¡** | å•å°æœåŠ¡å™¨æ‰›ä¸ä½æµé‡ | "æ¢ä¸€å°æ›´å¥½çš„æœåŠ¡å™¨" | æµé‡å†æ¶¨è¿˜æ˜¯æ‰›ä¸ä½ |
| **ç¬¬äºŒæ¬¡** | å¤šå°æœåŠ¡å™¨ä¸çŸ¥å¦‚ä½•åˆ†å‘æµé‡ | "ç›´æ¥æš´éœ²å¤šä¸ª IP ç»™ç”¨æˆ·" | ç”¨æˆ·è®¿é—®æ··ä¹±ï¼Œæ— æ³•å®ç°è´Ÿè½½å‡è¡¡ |
| **ç¬¬ä¸‰æ¬¡** | ç½‘ç«™è¢« DDoS æ”»å‡»ï¼ŒçœŸå® IP æš´éœ² | "åœ¨æ¯å°æœåŠ¡å™¨ä¸Šéƒ½é…ç½®é˜²ç«å¢™" | ç®¡ç†å¤æ‚ï¼Œé˜²æŠ¤æ•ˆæœå·® |
| **ç¬¬å››æ¬¡** | HTTPS é…ç½®å¤æ‚ï¼Œè¯ä¹¦ç®¡ç†æ··ä¹± | "æ¯å°æœåŠ¡å™¨éƒ½é…ç½® SSL è¯ä¹¦" | è¯ä¹¦æ›´æ–°éº»çƒ¦ï¼Œé…ç½®ä¸ä¸€è‡´ |

**æ ¸å¿ƒé¢†æ‚Ÿ**ï¼š**ä¸æ˜¯æœåŠ¡å™¨è¶Šå¤šè¶Šå¥½ï¼Œè€Œæ˜¯æµé‡ç®¡ç†è¶Šæ™ºèƒ½è¶Šå¥½**ã€‚

### 2.2 åå‘ä»£ç†åˆ°åº•åƒä»€ä¹ˆï¼Ÿ

**ç›´æ¥æš´éœ²æœåŠ¡å™¨** = **æ²¡æœ‰é—¨å«çš„å¤§æ¥¼**ï¼š
- ä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥æ‰¾åˆ°æˆ¿é—´ï¼ˆIPï¼‰ã€‚
- æ¥è®¿è€…ï¼ˆè¯·æ±‚ï¼‰ä¸çŸ¥é“å»å“ªä¸ªæˆ¿é—´ï¼Œå¯èƒ½éƒ½æŒ¤åœ¨ä¸€ä¸ªæˆ¿é—´ã€‚
- å®‰å…¨éšæ‚£å¤§ï¼Œåäººå¯ä»¥ç›´æ¥æ‰¾åˆ°æˆ¿é—´æç ´åã€‚

**åå‘ä»£ç†** = **æœ‰å‰å°çš„å¤§æ¥¼**ï¼š
- æ¥è®¿è€…ï¼ˆå®¢æˆ·ç«¯ï¼‰åªçŸ¥é“å‰å°åœ°å€ï¼ˆåå‘ä»£ç† IPï¼‰ã€‚
- å‰å°æ ¹æ®æƒ…å†µæŠŠæ¥è®¿è€…å¼•å¯¼åˆ°ä¸åŒçš„æˆ¿é—´ï¼ˆæœåŠ¡å™¨ï¼‰ã€‚
- æˆ¿é—´çš„çœŸå®ä½ç½®å¯¹å¤–ä¿å¯†ï¼Œå®‰å…¨æ€§é«˜ã€‚

**è¯¥å¹³å°çš„ç»éªŒ**ï¼š**å¤§æ¥¼è¦æœ‰å‰å°ï¼Œæµé‡è¦è¿‡ç½‘å…³**ã€‚

---

## 3. ç¬¬ä¸€æ­¥ï¼šNginx æ¶æ„ - ä¸ºä»€ä¹ˆå®ƒèƒ½æ‰›ä½ç™¾ä¸‡å¹¶å‘ï¼Ÿ

<NginxArchitectureDemo />

åœ¨æ·±å…¥é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ Nginx ä¸ºä»€ä¹ˆèƒ½å¤„ç†å¦‚æ­¤é«˜çš„å¹¶å‘ã€‚è¿™ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯ç²¾å¿ƒè®¾è®¡çš„æ¶æ„ã€‚

### 3.1 Master-Worker è¿›ç¨‹æ¨¡å‹

Nginx é‡‡ç”¨**å¤šè¿›ç¨‹**æ¶æ„ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ï¼š

**Master è¿›ç¨‹ï¼ˆç®¡ç†è€…ï¼‰**ï¼š
- è´Ÿè´£è¯»å–å’ŒéªŒè¯é…ç½®æ–‡ä»¶ã€‚
- ç®¡ç† Worker è¿›ç¨‹ï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡æ–°åŠ è½½ï¼‰ã€‚
- ä¸å¤„ç†å…·ä½“è¯·æ±‚ã€‚

**Worker è¿›ç¨‹ï¼ˆå·¥ä½œè€…ï¼‰**ï¼š
- å®é™…å¤„ç† HTTP è¯·æ±‚ã€‚
- æ¯ä¸ª Worker æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œç›¸äº’éš”ç¦»ã€‚
- æ•°é‡é€šå¸¸è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚

**ä¼˜åŠ¿**ï¼š
- ä¸€ä¸ª Worker å´©æºƒï¼Œä¸ä¼šå½±å“å…¶ä»– Workerã€‚
- å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚
- é¿å…å¤šçº¿ç¨‹ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚

### 3.2 äº‹ä»¶é©±åŠ¨ + å¼‚æ­¥éé˜»å¡

è¿™æ˜¯ Nginx é«˜æ€§èƒ½çš„æ ¸å¿ƒç§˜å¯†ï¼š

**ä¼ ç»Ÿ Apacheï¼ˆå¤šè¿›ç¨‹/çº¿ç¨‹æ¨¡å‹ï¼‰**ï¼š
- ä¸€ä¸ªè¿æ¥ = ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹ã€‚
- å¹¶å‘æ•°å—é™äºç³»ç»Ÿè¿›ç¨‹/çº¿ç¨‹æ•°ã€‚
- å¤§é‡è¿æ¥æ—¶ï¼Œè¿›ç¨‹åˆ‡æ¢å¼€é”€å·¨å¤§ã€‚

**Nginxï¼ˆäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼‰**ï¼š
- ä½¿ç”¨ epollï¼ˆLinuxï¼‰/ kqueueï¼ˆmacOSï¼‰ç­‰é«˜æ•ˆ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ã€‚
- ä¸€ä¸ª Worker è¿›ç¨‹å¯ä»¥åŒæ—¶å¤„ç†æ•°ä¸‡ä¸ªè¿æ¥ã€‚
- è¿æ¥æ²¡æœ‰æ•°æ®æ—¶ï¼Œä¸ä¼šå ç”¨ CPUï¼Œæœ‰æ–°æ•°æ®æ—¶é€šè¿‡äº‹ä»¶é€šçŸ¥å”¤é†’ã€‚

**æ¯”å–»**ï¼š
- Apache åƒé¤å…é‡Œæ¯ä¸ªé¡¾å®¢é…ä¸€ä¸ªæœåŠ¡å‘˜ï¼ˆè¿›ç¨‹ï¼‰ã€‚
- Nginx åƒä¸€ä¸ªè¶…çº§æœåŠ¡å‘˜ï¼ŒåŒæ—¶æœåŠ¡æ‰€æœ‰é¡¾å®¢ï¼Œè°éœ€è¦æœåŠ¡å°±å»è°é‚£é‡Œï¼Œè€Œä¸æ˜¯ä¸€ç›´ç«™åœ¨æŸä¸ªé¡¾å®¢æ—è¾¹ã€‚

### 3.3 ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®

```nginx
# è®¾ç½® Worker è¿›ç¨‹æ•°ï¼Œé€šå¸¸ç­‰äº CPU æ ¸å¿ƒæ•°
worker_processes auto;

# è®¾ç½®æ¯ä¸ª Worker çš„æœ€å¤§è¿æ¥æ•°
# æ€»å¹¶å‘è¿æ¥æ•° = worker_processes * worker_connections
events {
    worker_connections 4096;
    use epoll;  # Linux ä¸‹ä½¿ç”¨ epoll
    multi_accept on;  # å°½å¯èƒ½æ¥å—æ›´å¤šè¿æ¥
}

http {
    # å¼€å¯æ–‡ä»¶é«˜æ•ˆä¼ è¾“
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # é•¿è¿æ¥è¶…æ—¶æ—¶é—´
    keepalive_timeout 65;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;
}
```

---

## 4. ç¬¬äºŒæ­¥ï¼šAPI ç½‘å…³ - ç³»ç»Ÿçš„"ç»Ÿä¸€å¤§é—¨"

<ApiGatewayDemo />

å¦‚æœè¯´åå‘ä»£ç†æ˜¯"æµé‡ä¸­è½¬ç«™"ï¼Œé‚£ä¹ˆ API ç½‘å…³å°±æ˜¯"æ™ºèƒ½è°ƒåº¦ä¸­å¿ƒ"ã€‚å®ƒä¸ä»…ä»…æ˜¯è½¬å‘è¯·æ±‚ï¼Œè¿˜æ‰¿æ‹…äº†å¾ˆå¤šæ¨ªåˆ‡å…³æ³¨ç‚¹çš„å¤„ç†ã€‚

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ API ç½‘å…³ï¼Ÿ

æƒ³è±¡ä¸€ä¸ªæ²¡æœ‰ç½‘å…³çš„ç³»ç»Ÿï¼š
- å®¢æˆ·ç«¯éœ€è¦çŸ¥é“å¤šä¸ªæœåŠ¡çš„åœ°å€ï¼ˆç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡...ï¼‰ã€‚
- æ¯ä¸ªæœåŠ¡éƒ½è¦è‡ªå·±åšè®¤è¯ã€é™æµã€æ—¥å¿—ã€‚
- åè®®ä¸ç»Ÿä¸€ï¼Œæœ‰çš„ç”¨ HTTPï¼Œæœ‰çš„ç”¨ gRPCã€‚
- æœåŠ¡å‡çº§æ—¶ï¼Œå®¢æˆ·ç«¯ä¹Ÿéœ€è¦è·Ÿç€æ”¹ã€‚

**æœ‰äº† API ç½‘å…³ä¹‹å**ï¼š
- å®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“ç½‘å…³åœ°å€ï¼Œç½‘å…³è´Ÿè´£è·¯ç”±åˆ°æ­£ç¡®æœåŠ¡ã€‚
- è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰æ¨ªåˆ‡é€»è¾‘ç»Ÿä¸€åœ¨ç½‘å…³å¤„ç†ã€‚
- ç½‘å…³å¯ä»¥åšåè®®è½¬æ¢ï¼Œå¯¹å¤–ç»Ÿä¸€æš´éœ² HTTPã€‚
- åç«¯æœåŠ¡å‡çº§ï¼Œåªéœ€è¦æ”¹ç½‘å…³é…ç½®ï¼Œå®¢æˆ·ç«¯æ— æ„ŸçŸ¥ã€‚

### 4.2 API ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ | å…¸å‹åœºæ™¯ |
| :--- | :--- | :--- |
| **è·¯ç”±è½¬å‘** | æ ¹æ® URLã€Header ç­‰è§„åˆ™ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒæœåŠ¡ | `/api/users` â†’ ç”¨æˆ·æœåŠ¡ï¼Œ`/api/orders` â†’ è®¢å•æœåŠ¡ |
| **è´Ÿè½½å‡è¡¡** | åŒä¸€ä¸ªæœåŠ¡æœ‰å¤šå®ä¾‹æ—¶ï¼Œåˆ†æ‘Šæµé‡ | ç”¨æˆ·æœåŠ¡æœ‰ 3 å°å®ä¾‹ï¼Œè½®è¯¢åˆ†å‘è¯·æ±‚ |
| **è®¤è¯é‰´æƒ** | ç»Ÿä¸€æ ¡éªŒ JWTã€OAuth Token | æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—® `/api/admin` |
| **é™æµç†”æ–­** | æ§åˆ¶æµé‡ä¸Šé™ï¼Œé˜²æ­¢æœåŠ¡è¢«å‹å® | æ¯ç§’æœ€å¤š 1000 è¯·æ±‚ï¼Œè¶…è¿‡è¿”å› 429 |
| **åè®®è½¬æ¢** | å¯¹å¤– HTTPï¼Œå†…éƒ¨å¯è½¬ gRPC | å®¢æˆ·ç«¯ç”¨ HTTPï¼Œç½‘å…³è½¬ gRPC è°ƒç”¨å†…éƒ¨æœåŠ¡ |
| **ç°åº¦å‘å¸ƒ** | æŒ‰ Header æˆ–æ¯”ä¾‹ï¼Œå°†éƒ¨åˆ†æµé‡å¯¼åˆ°æ–°ç‰ˆæœ¬ | 5% ç”¨æˆ·ä½“éªŒæ–°ç‰ˆæœ¬ï¼Œ95% ç”¨æ—§ç‰ˆæœ¬ |
| **æ—¥å¿—ç›‘æ§** | ç»Ÿä¸€è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œä¾¿äºåˆ†æå’Œæ’éšœ | è®°å½•æ¯æ¬¡è¯·æ±‚çš„è€—æ—¶ã€çŠ¶æ€ç ã€è¿”å›å¤§å° |

### 4.3 Nginx vs Kong vs Spring Cloud Gateway

å¸‚é¢ä¸Šæœ‰å¾ˆå¤šç½‘å…³äº§å“ï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ

| ç»´åº¦ | Nginx | Kong | Spring Cloud Gateway |
| :--- | :--- | :--- | :--- |
| **å®šä½** | é«˜æ€§èƒ½åå‘ä»£ç†/è´Ÿè½½å‡è¡¡ | å¼€æº API ç½‘å…³ | Spring ç”Ÿæ€ç½‘å…³ |
| **æ€§èƒ½** | æé«˜ï¼ˆC è¯­è¨€ï¼Œäº‹ä»¶é©±åŠ¨ï¼‰ | é«˜ï¼ˆåŸºäº OpenRestyï¼‰ | ä¸­ç­‰ï¼ˆJavaï¼Œå“åº”å¼ï¼‰ |
| **åŠŸèƒ½** | åŸºç¡€è´Ÿè½½å‡è¡¡ã€é™æ€æ–‡ä»¶ã€ç¼“å­˜ | ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼ˆè®¤è¯ã€é™æµã€æ—¥å¿—ç­‰ï¼‰ | ä¸ Spring Cloud æ·±åº¦é›†æˆ |
| **é…ç½®** | é…ç½®æ–‡ä»¶ï¼ˆnginx.confï¼‰ | REST API + é…ç½®æ–‡ä»¶ | Java é…ç½® / YAML |
| **æ‰©å±•** | C æ¨¡å— / Lua è„šæœ¬ | Lua æ’ä»¶ | Java è¿‡æ»¤å™¨ |
| **é€‚ç”¨åœºæ™¯** | é™æ€èµ„æºã€ä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€SSL ç»ˆç»“ | å¾®æœåŠ¡ API ç½‘å…³ã€å¤šç§Ÿæˆ· SaaS | Spring Cloud å¾®æœåŠ¡æ¶æ„ |

**é€‰å‹å»ºè®®**ï¼š
- **ä¸­å°å‹é¡¹ç›® / é™æ€èµ„æºä¸ºä¸»**ï¼šNginx è¶³å¤Ÿã€‚
- **å¤§å‹å¾®æœåŠ¡ / éœ€è¦ä¸°å¯Œæ’ä»¶**ï¼šKongã€‚
- **Spring Cloud å…¨å®¶æ¡¶**ï¼šSpring Cloud Gatewayã€‚

---

## 5. ç¬¬ä¸‰æ­¥ï¼šè·¯ç”±ä¸è´Ÿè½½å‡è¡¡ - æŠŠè¯·æ±‚é€åˆ°æ­£ç¡®çš„åœ°æ–¹

<RoutingRulesDemo />
<LoadBalancingDemo />

ç½‘å…³çš„æ ¸å¿ƒèŒè´£ä¹‹ä¸€ï¼Œå°±æ˜¯**æŠŠè¯·æ±‚é€åˆ°æ­£ç¡®çš„åœ°æ–¹**ã€‚è¿™æ¶‰åŠä¸¤ä¸ªå…³é”®èƒ½åŠ›ï¼š**è·¯ç”±**ï¼ˆå»å“ªå°æœåŠ¡å™¨ï¼‰å’Œ**è´Ÿè½½å‡è¡¡**ï¼ˆæ€ä¹ˆåˆ†é…æµé‡ï¼‰ã€‚

### 5.1 è·¯ç”±è§„åˆ™ï¼šä» URL åˆ°æœåŠ¡

æƒ³è±¡ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œä¸åŒçš„ URL å¯¹åº”ä¸åŒçš„æœåŠ¡ï¼š
- `/api/users/*` â†’ ç”¨æˆ·æœåŠ¡
- `/api/orders/*` â†’ è®¢å•æœåŠ¡
- `/api/products/*` â†’ å•†å“æœåŠ¡
- `/api/pay/*` â†’ æ”¯ä»˜æœåŠ¡

**Nginx é…ç½®ç¤ºä¾‹**ï¼š

```nginx
server {
    listen 80;
    server_name api.example.com;

    # ç”¨æˆ·æœåŠ¡
    location /api/users/ {
        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # è®¢å•æœåŠ¡
    location /api/orders/ {
        proxy_pass http://order-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # å•†å“æœåŠ¡
    location /api/products/ {
        proxy_pass http://product-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # æ”¯ä»˜æœåŠ¡ï¼ˆéœ€è¦æ›´é«˜å®‰å…¨çº§åˆ«ï¼‰
    location /api/pay/ {
        # é™åˆ¶ IP è®¿é—®
        allow 10.0.0.0/8;
        deny all;

        proxy_pass http://payment-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**é«˜çº§è·¯ç”±è§„åˆ™**ï¼š

```nginx
# åŸºäºè¯·æ±‚æ–¹æ³•çš„è·¯ç”±
if ($request_method = POST) {
    proxy_pass http://write-service;
}

# åŸºäº Header çš„è·¯ç”±ï¼ˆç°åº¦å‘å¸ƒï¼‰
if ($http_x_version = "v2") {
    proxy_pass http://api-v2;
}

# åŸºäº Cookie çš„è·¯ç”±ï¼ˆAB æµ‹è¯•ï¼‰
if ($cookie_test_group = "B") {
    proxy_pass http://variant-b;
}

# åŸºäº Query å‚æ•°çš„è·¯ç”±
if ($arg_format = "json") {
    proxy_pass http://json-api;
}
```

### 5.2 è´Ÿè½½å‡è¡¡ï¼šå››ç§ç­–ç•¥å¯¹æ¯”

å½“åŒä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªå®ä¾‹æ—¶ï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ

| ç­–ç•¥ | åŸç† | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| :--- | :--- | :--- | :--- | :--- |
| **è½®è¯¢** (Round Robin) | æŒ‰é¡ºåºä¾æ¬¡åˆ†é…ç»™æ¯å°æœåŠ¡å™¨ | æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ | ç®€å•å…¬å¹³ | ä¸è€ƒè™‘æœåŠ¡å™¨å½“å‰è´Ÿè½½ |
| **åŠ æƒè½®è¯¢** (Weighted RR) | æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…ï¼Œæƒé‡é«˜çš„åˆ†é…æ›´å¤š | æœåŠ¡å™¨æ€§èƒ½ä¸å‡ | å……åˆ†åˆ©ç”¨é«˜æ€§èƒ½æœåŠ¡å™¨ | éœ€è¦åˆç†è®¾ç½®æƒé‡ |
| **æœ€å°‘è¿æ¥** (Least Connections) | åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ | é•¿è¿æ¥åœºæ™¯ï¼ˆWebSocketã€è§†é¢‘æµï¼‰ | åŠ¨æ€é€‚åº”è´Ÿè½½å˜åŒ– | éœ€è¦å®æ—¶ç»Ÿè®¡è¿æ¥æ•° |
| **IP å“ˆå¸Œ** (IP Hash) | æ ¹æ®å®¢æˆ·ç«¯ IP è®¡ç®—å“ˆå¸Œï¼ŒåŒä¸€ IP æ°¸è¿œåˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ | éœ€è¦ä¼šè¯ä¿æŒçš„åœºæ™¯ | ä¿è¯ä¼šè¯ä¸€è‡´æ€§ | æŸä¸ª IP æµé‡å¤§æ—¶ä¼šé€ æˆå•ç‚¹å‹åŠ› |

**Nginx é…ç½®ç¤ºä¾‹**ï¼š

```nginx
# å®šä¹‰ upstream ç»„
upstream backend {
    # è½®è¯¢ï¼ˆé»˜è®¤ï¼‰
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
    server 10.0.1.12:8080;
}

upstream backend_weighted {
    # åŠ æƒè½®è¯¢
    server 10.0.1.10:8080 weight=3;  # æ€§èƒ½å¥½ï¼Œæ‰¿æ‹…æ›´å¤šæµé‡
    server 10.0.1.11:8080 weight=2;
    server 10.0.1.12:8080 weight=1;  # æ€§èƒ½å·®ï¼Œæ‰¿æ‹…è¾ƒå°‘æµé‡
}

upstream backend_least_conn {
    # æœ€å°‘è¿æ¥
    least_conn;
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
    server 10.0.1.12:8080;
}

upstream backend_ip_hash {
    # IP å“ˆå¸Œï¼ˆä¼šè¯ä¿æŒï¼‰
    ip_hash;
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
    server 10.0.1.12:8080;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—æˆ– Nginx Plusï¼‰
        # health_check;
    }
}
```

### 5.3 é¿å‘æŒ‡å—ï¼šè´Ÿè½½å‡è¡¡çš„å¸¸è§è¯¯åŒº

#### è¯¯åŒº 1ï¼šå¿½è§†å¥åº·æ£€æŸ¥

```nginx
# âŒ é”™è¯¯ï¼šæ²¡æœ‰å¥åº·æ£€æŸ¥ï¼Œåç«¯æœåŠ¡å®•æœºäº†ï¼Œæµé‡è¿˜ä¼šç»§ç»­å‘é€
upstream backend {
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;  # è¿™å°å®•æœºäº†ï¼Œè¯·æ±‚ä¼šå¤±è´¥
}

# âœ… æ­£ç¡®ï¼šé…ç½®å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰
upstream backend {
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;

    # ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆNginx Plus æˆ–é…ç½® check æ¨¡å—ï¼‰
    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

#### è¯¯åŒº 2ï¼šä¼šè¯ä¿æŒæ»¥ç”¨

```nginx
# âŒ é”™è¯¯ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨ IP å“ˆå¸Œï¼Œå¯¼è‡´è´Ÿè½½ä¸å‡
upstream backend {
    ip_hash;  # æŸäº› IP æµé‡ç‰¹åˆ«å¤§ï¼Œå¯¼è‡´å•ç‚¹å‹åŠ›
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
}

# âœ… æ­£ç¡®ï¼šéœ€è¦ä¼šè¯ä¿æŒçš„æ‰ç”¨ IP å“ˆå¸Œï¼Œå…¶ä»–ç”¨è½®è¯¢
upstream backend {
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
}

upstream backend_session {
    ip_hash;
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;
}

server {
    location /api/ {
        proxy_pass http://backend;  # æ™®é€š APIï¼Œæ— éœ€ä¼šè¯ä¿æŒ
    }

    location /cart/ {
        proxy_pass http://backend_session;  # è´­ç‰©è½¦ï¼Œéœ€è¦ä¼šè¯ä¿æŒ
    }
}
```

#### è¯¯åŒº 3ï¼šå¿½è§†åç«¯è·å–çœŸå® IP

```nginx
# âŒ é”™è¯¯ï¼šåç«¯åº”ç”¨è·å–åˆ°çš„ IP æ˜¯ Nginx çš„ IPï¼Œä¸æ˜¯å®¢æˆ·ç«¯çœŸå® IP
server {
    location / {
        proxy_pass http://backend;
        # ç¼ºå°‘ Header è®¾ç½®
    }
}

# âœ… æ­£ç¡®ï¼šä¼ é€’çœŸå® IP å’Œåè®®ä¿¡æ¯
server {
    location / {
        proxy_pass http://backend;

        # å¿…é¡»è®¾ç½®çš„ Header
        proxy_set_header Host $host;  # åŸå§‹ Host
        proxy_set_header X-Real-IP $remote_addr;  # å®¢æˆ·ç«¯çœŸå® IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # ä»£ç†é“¾
        proxy_set_header X-Forwarded-Proto $scheme;  # åŸå§‹åè®®ï¼ˆhttp/httpsï¼‰

        # å¦‚æœåç«¯ä¹Ÿæ˜¯ Nginxï¼Œå¯ä»¥è®¾ç½®çœŸå®ç«¯å£
        proxy_set_header X-Forwarded-Port $server_port;
    }
}
```

åç«¯åº”ç”¨ï¼ˆä»¥ Node.js Express ä¸ºä¾‹ï¼‰è·å–çœŸå® IPï¼š

```javascript
const express = require('express');
const app = express();

// ä¿¡ä»»ä»£ç†ï¼ˆå¿…é¡»è®¾ç½®ï¼Œå¦åˆ™ X-Forwarded-* ä¼šè¢«å¿½ç•¥ï¼‰
app.set('trust proxy', true);

app.get('/api/test', (req, res) => {
    res.json({
        // å®¢æˆ·ç«¯çœŸå® IPï¼ˆç»è¿‡ä»£ç†é“¾åçš„ç¬¬ä¸€ä¸ª IPï¼‰
        realIp: req.ip,

        // å®Œæ•´çš„ä»£ç†é“¾ï¼ˆå®¢æˆ·ç«¯, ä»£ç†1, ä»£ç†2, ...ï¼‰
        forwardedFor: req.get('X-Forwarded-For'),

        // åŸå§‹åè®®ï¼ˆhttp æˆ– httpsï¼‰
        protocol: req.protocol,

        // åŸå§‹ Host
        host: req.get('Host')
    });
});

app.listen(3000);
```

---

## 4. ç¬¬ä¸‰æ­¥ï¼šé™æµä¸ç†”æ–­ - é˜²æ­¢ç³»ç»Ÿè¢«"æµé‡æ´ªæ°´"å†²å®

<RateLimitingDemo />

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¿æŠ¤ç³»ç»Ÿä¸è¢«çªå‘æµé‡å‹å®ï¼Œæ˜¯ç½‘å…³çš„æ ¸å¿ƒèŒè´£ä¹‹ä¸€ã€‚è¿™éœ€è¦ç”¨åˆ°**é™æµ**å’Œ**ç†”æ–­**æœºåˆ¶ã€‚

### 4.1 é™æµç®—æ³•å¯¹æ¯”ï¼šä»¤ç‰Œæ¡¶ vs æ¼æ¡¶ vs æ»‘åŠ¨çª—å£

| ç®—æ³• | æ ¸å¿ƒæ€æƒ³ | çªå‘æµé‡ | é€‚ç”¨åœºæ™¯ | å®ç°å¤æ‚åº¦ |
| :--- | :--- | :--- | :--- | :--- |
| **ä»¤ç‰Œæ¡¶** | æ¡¶é‡Œè£…ä»¤ç‰Œï¼Œæœ‰ä»¤ç‰Œæ‰èƒ½é€šè¿‡ | å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘ | API é™æµã€å¸¦å®½æ§åˆ¶ | ä¸­ç­‰ |
| **æ¼æ¡¶** | è¯·æ±‚è¿›æ¡¶ï¼ŒåŒ€é€Ÿæµå‡ºå¤„ç† | å¼ºåˆ¶å¹³æ»‘ï¼Œçªå‘ä¼šè¢«ç¼“å­˜æˆ–æ‹’ç» | éœ€è¦ä¸¥æ ¼åŒ€é€Ÿå¤„ç†çš„åœºæ™¯ | ä¸­ç­‰ |
| **æ»‘åŠ¨çª—å£** | ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•° | ä¸¥æ ¼æŒ‰çª—å£è®¡æ•°ï¼Œè¶…å‡ºä¸€å¾‹æ‹’ç» | ç²¾ç¡®ç»Ÿè®¡ï¼ˆå¦‚"1åˆ†é’Ÿå†…æœ€å¤š100æ¬¡"ï¼‰ | è¾ƒé«˜ |

### 4.2 Nginx é™æµé…ç½®å®æˆ˜

```nginx
# å®šä¹‰é™æµåŒºåŸŸï¼ˆæ”¾åœ¨ http å—ä¸­ï¼‰

# 1. åŸºäº IP çš„é™æµï¼ˆæ¼æ¡¶ç®—æ³•ï¼‰
# zone=mylimit:10m - åŒºåŸŸåç§°å’Œå†…å­˜å¤§å°ï¼ˆ10MB çº¦å¯å­˜å‚¨ 16 ä¸‡ IPï¼‰
# rate=10r/s - æ¯ç§’å…è®¸ 10 ä¸ªè¯·æ±‚
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

# 2. åŸºäº IP çš„è¿æ¥æ•°é™åˆ¶ï¼ˆé˜²æ­¢å•ä¸ª IP å»ºç«‹è¿‡å¤šè¿æ¥ï¼‰
limit_conn_zone $binary_remote_addr zone=addr:10m;

# 3. åŸºäºæœåŠ¡ç«¯ç‚¹çš„é™æµï¼ˆä¸åŒºåˆ† IPï¼Œä¿æŠ¤åç«¯æ•´ä½“ï¼‰
limit_req_zone $server_name zone=server_limit:10m rate=100r/s;

server {
    listen 80;
    server_name api.example.com;

    # ç”¨æˆ·æœåŠ¡ - æ™®é€šé™æµ
    location /api/users/ {
        # åº”ç”¨é™æµ
        # burst=20 - æ¡¶å®¹é‡ï¼Œå…è®¸çªå‘ 20 ä¸ªè¯·æ±‚
        # nodelay - ä¸å»¶è¿Ÿå¤„ç†çªå‘è¯·æ±‚ï¼ˆç«‹å³å¤„ç†æˆ–æ‹’ç»ï¼‰
        limit_req zone=mylimit burst=20 nodelay;

        # é™åˆ¶å•ä¸ª IP çš„è¿æ¥æ•°
        limit_conn addr 10;

        proxy_pass http://user-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # è®¢å•æœåŠ¡ - æ›´ä¸¥æ ¼çš„é™æµ
    location /api/orders/ {
        # æ›´ä¸¥æ ¼çš„é™æµï¼šæ¯ç§’ 5 ä¸ªè¯·æ±‚
        limit_req_zone $binary_remote_addr zone=order_limit:10m rate=5r/s;
        limit_req zone=order_limit burst=10 nodelay;

        proxy_pass http://order-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # æ”¯ä»˜æœåŠ¡ - æœ€é«˜çº§åˆ«ä¿æŠ¤
    location /api/pay/ {
        # å¤šå±‚é™æµä¿æŠ¤

        # ç¬¬ä¸€å±‚ï¼šå• IP é™æµï¼ˆæ¯ç§’ 2 ä¸ªè¯·æ±‚ï¼‰
        limit_req_zone $binary_remote_addr zone=pay_ip_limit:10m rate=2r/s;
        limit_req zone=pay_ip_limit burst=5 nodelay;

        # ç¬¬äºŒå±‚ï¼šå…¨å±€é™æµï¼ˆä¿æŠ¤åç«¯æ•°æ®åº“ï¼‰
        limit_req zone=server_limit burst=50 nodelay;

        # ç¬¬ä¸‰å±‚ï¼šè¿æ¥æ•°é™åˆ¶
        limit_conn addr 5;

        # åªå…è®¸å†…ç½‘è®¿é—®ï¼ˆé¢å¤–å®‰å…¨å±‚ï¼‰
        allow 10.0.0.0/8;
        deny all;

        proxy_pass http://payment-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # æ”¯ä»˜æ¥å£å¢åŠ è¶…æ—¶æ—¶é—´
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # é™æµåçš„å¤„ç†
    # å½“è¯·æ±‚è¢«é™æµæ—¶ï¼Œè¿”å› 429 Too Many Requests
    error_page 429 /429.html;
    location = /429.html {
        internal;
        return 429 '{"error": "Too Many Requests", "message": "Rate limit exceeded. Please try again later."}';
        add_header Content-Type application/json;
    }
}
```

### 4.3 ç†”æ–­é™çº§ï¼šå½“ä¾èµ–æœåŠ¡å‡ºé—®é¢˜æ—¶

é™æµæ˜¯é˜²æ­¢å¤–éƒ¨æµé‡å‹å®ç³»ç»Ÿï¼Œ**ç†”æ–­**æ˜¯é˜²æ­¢å†…éƒ¨ä¾èµ–æ•…éšœæ‰©æ•£ã€‚

**ç†”æ–­å™¨çš„å·¥ä½œåŸç†**ï¼š
1. **å…³é—­çŠ¶æ€**ï¼šæ­£å¸¸è½¬å‘è¯·æ±‚ï¼ŒåŒæ—¶ç»Ÿè®¡é”™è¯¯ç‡ã€‚
2. **å¼€å¯çŠ¶æ€**ï¼šå½“é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ï¼Œç†”æ–­å™¨å¼€å¯ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸å†è½¬å‘è¯·æ±‚ã€‚
3. **åŠå¼€çŠ¶æ€**ï¼šç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œå…è®¸å°‘é‡è¯·æ±‚é€šè¿‡è¯•æ¢ï¼Œå¦‚æœæˆåŠŸåˆ™å…³é—­ç†”æ–­å™¨ã€‚

**Nginx å®ç°ç†”æ–­ï¼ˆä½¿ç”¨ Lua æ¨¡å—æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰**ï¼š

```nginx
# ä½¿ç”¨ nginx-upsync-module æˆ– lua-resty-healthcheck å®ç°å¥åº·æ£€æŸ¥å’Œç†”æ–­

upstream backend {
    server 10.0.1.10:8080;
    server 10.0.1.11:8080;

    # å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦ nginx_upstream_check_moduleï¼‰
    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}

server {
    location / {
        proxy_pass http://backend;

        # ä»£ç†é”™è¯¯æ—¶è¿”å›è‡ªå®šä¹‰é”™è¯¯é¡µï¼ˆé™çº§ï¼‰
        proxy_intercept_errors on;
        error_page 500 502 503 504 /fallback.html;
    }

    location = /fallback.html {
        internal;
        # è¿”å›é™çº§æ•°æ®ï¼ˆå¦‚ç¼“å­˜æ•°æ®ã€ç®€åŒ–ç‰ˆé¡µé¢ï¼‰
        return 200 '{"status": "degraded", "message": "Service temporarily unavailable. Showing cached data."}';
        add_header Content-Type application/json;
    }
}
```

**ä½¿ç”¨ OpenResty + Lua å®ç°æ›´å®Œå–„çš„ç†”æ–­**ï¼š

```lua
-- ä½¿ç”¨ lua-resty-circuit-breaker åº“å®ç°ç†”æ–­
local circuit_breaker = require "resty.circuit-breaker"

local cb = circuit_breaker.new({
    name = "payment_service",
    group = "payment",
    -- ç†”æ–­ç­–ç•¥
    failure_threshold = 5,      -- è¿ç»­å¤±è´¥ 5 æ¬¡è§¦å‘ç†”æ–­
    success_threshold = 2,    -- è¿ç»­æˆåŠŸ 2 æ¬¡å…³é—­ç†”æ–­
    timeout = 60,              -- ç†”æ–­åç­‰å¾… 60 ç§’è¿›å…¥åŠå¼€çŠ¶æ€
    -- é”™è¯¯ç±»å‹
    expected_statuses = {200, 201},  -- æœŸæœ›çš„ HTTP çŠ¶æ€ç 
    ignored_statuses = {404, 422},   -- ä¸è®¡å…¥å¤±è´¥çš„ status
})

-- ä½¿ç”¨ç†”æ–­å™¨æ‰§è¡Œè¯·æ±‚
local ok, err = cb:execute(function()
    -- å‘èµ· HTTP è¯·æ±‚
    local httpc = require "resty.http".new()
    local res, err = httpc:request_uri("http://payment-service/charge", {
        method = "POST",
        body = body,
        headers = {
            ["Content-Type"] = "application/json",
        },
    })

    if not res then
        return nil, err
    end

    return res
end)

if not ok then
    -- ç†”æ–­å™¨å¼€å¯æˆ–è¯·æ±‚å¤±è´¥ï¼Œæ‰§è¡Œé™çº§é€»è¾‘
    ngx.log(ngx.WARN, "Circuit breaker open or request failed: ", err)

    -- è¿”å›é™çº§å“åº”
    ngx.status = 503
    ngx.say('{"error": "Service temporarily unavailable", "fallback": true}')
    return
end

-- è¯·æ±‚æˆåŠŸï¼Œè¿”å›æ­£å¸¸å“åº”
ngx.status = res.status
ngx.say(res.body)
```

---

## 6. ç¬¬å››æ­¥ï¼šè®¤è¯ä¸å®‰å…¨ - å®ˆæŠ¤å¤§é—¨çš„"é—¨å«"

<AuthMiddlewareDemo />

ç½‘å…³æ˜¯ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œè‡ªç„¶ä¹Ÿæˆä¸º**å®‰å…¨é˜²æŠ¤çš„ç¬¬ä¸€é“é˜²çº¿**ã€‚åœ¨ç½‘å…³å±‚å¤„ç†è®¤è¯å’Œå®‰å…¨ï¼Œå¯ä»¥é¿å…æ¯ä¸ªåç«¯æœåŠ¡é‡å¤å®ç°ã€‚

### 6.1 åœ¨ç½‘å…³å±‚ç»Ÿä¸€è®¤è¯

**ä¼ ç»Ÿæ–¹å¼ï¼ˆæ¯ä¸ªæœåŠ¡å„è‡ªè®¤è¯ï¼‰**ï¼š
- ç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡...æ¯ä¸ªéƒ½è¦æ ¡éªŒ JWTã€‚
- ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾ã€‚
-  secret åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ï¼Œæ³„éœ²é£é™©é«˜ã€‚

**ç½‘å…³ç»Ÿä¸€è®¤è¯**ï¼š
- å®¢æˆ·ç«¯æºå¸¦ Token è®¿é—®ç½‘å…³ã€‚
- ç½‘å…³æ ¡éªŒ Token åˆæ³•æ€§ï¼ˆç­¾åã€è¿‡æœŸæ—¶é—´ï¼‰ã€‚
- æ ¡éªŒé€šè¿‡åï¼Œå°†ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ user_idï¼‰æ·»åŠ åˆ°è¯·æ±‚å¤´ï¼Œè½¬å‘ç»™åç«¯æœåŠ¡ã€‚
- åç«¯æœåŠ¡æ— éœ€æ ¡éªŒï¼Œç›´æ¥ä» Header è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

**Nginx + Lua å®ç° JWT æ ¡éªŒ**ï¼š

```nginx
server {
    listen 80;
    server_name api.example.com;

    location / {
        # ä½¿ç”¨ access_by_lua_block è¿›è¡Œè®¤è¯
        access_by_lua_block {
            local jwt = require "resty.jwt"

            -- ä»è¯·æ±‚å¤´è·å– Token
            local auth_header = ngx.var.http_authorization
            if not auth_header then
                ngx.status = 401
                ngx.say('{"error": "Missing authorization header"}')
                ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            -- æå– Tokenï¼ˆBearer tokenï¼‰
            local token = auth_header:match("^Bearer%s+(.+)$")
            if not token then
                ngx.status = 401
                ngx.say('{"error": "Invalid authorization format"}')
                ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            -- éªŒè¯ JWT
            local jwt_obj = jwt:verify("your-secret-key", token)
            if not jwt_obj.verified then
                ngx.status = 401
                ngx.say('{"error": "Invalid or expired token"}')
                ngx.exit(ngx.HTTP_UNAUTHORIZED)
            end

            -- å°†ç”¨æˆ·ä¿¡æ¯è®¾ç½®åˆ°å˜é‡ï¼Œä¾›åç»­ä½¿ç”¨
            ngx.var.user_id = jwt_obj.payload.sub
            ngx.var.user_role = jwt_obj.payload.role
        }

        # å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™åç«¯æœåŠ¡
        proxy_set_header X-User-ID $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_pass http://backend;
    }

    # å…¬å¼€æ¥å£ï¼Œæ— éœ€è®¤è¯
    location /api/public/ {
        proxy_pass http://backend;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 6.2 HTTPS ä¸ SSL ç»ˆç»“

<SslTerminationDemo />

HTTPS æ˜¯ç°ä»£ Web åº”ç”¨çš„æ ‡é…ã€‚ä½†å¦‚æœåœ¨æ¯å°åç«¯æœåŠ¡å™¨éƒ½é…ç½® HTTPSï¼Œä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦ï¼š
- è¯ä¹¦ç®¡ç†å¤æ‚ï¼Œæ¯å°æœåŠ¡å™¨éƒ½è¦éƒ¨ç½²ã€æ›´æ–°è¯ä¹¦ã€‚
- åç«¯æœåŠ¡éœ€è¦å¤„ç† TLS æ¡æ‰‹ï¼Œæ¶ˆè€— CPU èµ„æºã€‚
- é…ç½®å®¹æ˜“å‡ºé”™ï¼Œä¸ä¸€è‡´ã€‚

**SSL ç»ˆç»“ï¼ˆSSL Terminationï¼‰** æ–¹æ¡ˆï¼š
- åªåœ¨ç½‘å…³ï¼ˆNginxï¼‰å±‚é…ç½® HTTPS å’Œè¯ä¹¦ã€‚
- ç½‘å…³è´Ÿè´£ TLS æ¡æ‰‹å’ŒåŠ è§£å¯†ã€‚
- ç½‘å…³å’Œåç«¯æœåŠ¡ä¹‹é—´ä½¿ç”¨ HTTP æ˜æ–‡ä¼ è¾“ï¼ˆå†…éƒ¨ç½‘ç»œå¯ä¿¡ï¼‰ã€‚
- åç«¯æœåŠ¡ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€å¤„ç† TLSã€‚

**SSL ç»ˆç»“æµç¨‹**ï¼š
1. å®¢æˆ·ç«¯å‘é€ HTTPS è¯·æ±‚åˆ° Nginxã€‚
2. Nginx å’Œå®¢æˆ·ç«¯å®Œæˆ TLS æ¡æ‰‹ï¼Œå»ºç«‹åŠ å¯†é€šé“ã€‚
3. Nginx è§£å¯†è¯·æ±‚ï¼Œå¾—åˆ°æ˜æ–‡ HTTP è¯·æ±‚ã€‚
4. Nginx å°†æ˜æ–‡ HTTP è¯·æ±‚è½¬å‘ç»™åç«¯æœåŠ¡ï¼ˆé€šè¿‡å†…éƒ¨ç½‘ç»œï¼‰ã€‚
5. åç«¯æœåŠ¡å¤„ç†è¯·æ±‚ï¼Œè¿”å›æ˜æ–‡ HTTP å“åº”ç»™ Nginxã€‚
6. Nginx åŠ å¯†å“åº”ï¼Œé€šè¿‡ HTTPS è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**Nginx HTTPS é…ç½®**ï¼š

```nginx
server {
    # ç›‘å¬ 443 ç«¯å£ï¼Œå¯ç”¨ SSL
    listen 443 ssl http2;
    server_name api.example.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/api.example.com.crt;  # è¯ä¹¦æ–‡ä»¶
    ssl_certificate_key /etc/nginx/ssl/api.example.com.key;  # ç§é’¥æ–‡ä»¶

    # SSL åè®®å’Œå¯†ç å¥—ä»¶ï¼ˆå®‰å…¨é…ç½®ï¼‰
    ssl_protocols TLSv1.2 TLSv1.3;  # åªå¯ç”¨å®‰å…¨çš„ TLS ç‰ˆæœ¬
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;  # å¼ºå¯†ç å¥—ä»¶
    ssl_prefer_server_ciphers off;  # ä¼˜å…ˆä½¿ç”¨å®¢æˆ·ç«¯æ”¯æŒçš„å¯†ç å¥—ä»¶

    # SSL ä¼šè¯ç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
    ssl_session_cache shared:SSL:50m;  # ä¼šè¯ç¼“å­˜å¤§å°
    ssl_session_timeout 1d;  # ä¼šè¯è¶…æ—¶æ—¶é—´
    ssl_session_tickets off;  # ç¦ç”¨ä¼šè¯ç¥¨è¯ï¼ˆå‰å‘å®‰å…¨ï¼‰

    # OCSP Staplingï¼ˆæå‡æ€§èƒ½å’Œéšç§ï¼‰
    ssl_stapling on;  # å¯ç”¨ OCSP Stapling
    ssl_stapling_verify on;  # éªŒè¯ OCSP å“åº”
    ssl_trusted_certificate /etc/nginx/ssl/chain.crt;  # ä¿¡ä»»é“¾
    resolver 8.8.8.8 8.8.4.4 valid=300s;  # DNS è§£æå™¨
    resolver_timeout 5s;  # DNS è§£æè¶…æ—¶

    # å®‰å…¨å“åº”å¤´
    add_header Strict-Transport-Security "max-age=63072000" always;  # HSTS
    add_header X-Frame-Options "SAMEORIGIN" always;  # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    add_header X-Content-Type-Options "nosniff" always;  # é˜²æ­¢ MIME å—…æ¢
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;  # Referrer ç­–ç•¥

    # SSL ç»ˆç»“åï¼Œè½¬å‘åˆ°åç«¯ HTTP æœåŠ¡
    location / {
        proxy_pass http://backend;  # åç«¯ä½¿ç”¨ HTTP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;  # ä¼ é€’åŸå§‹åè®®ï¼ˆhttpsï¼‰
        proxy_set_header X-Forwarded-Port 443;  # ä¼ é€’åŸå§‹ç«¯å£
    }
}

# HTTP é‡å®šå‘åˆ° HTTPSï¼ˆå¼ºåˆ¶ HTTPSï¼‰
server {
    listen 80;
    server_name api.example.com;

    # æ‰€æœ‰ HTTP è¯·æ±‚ 301 é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}
```

### 6.3 å®‰å…¨é…ç½®æ¸…å•

| é…ç½®é¡¹ | è¯´æ˜ | æ¨èå€¼ |
| :--- | :--- | :--- |
| **SSL åè®®** | å¯ç”¨çš„ TLS ç‰ˆæœ¬ | `TLSv1.2 TLSv1.3`ï¼ˆç¦ç”¨ SSLv3ã€TLSv1.0/1.1ï¼‰ |
| **å¯†ç å¥—ä»¶** | åŠ å¯†ç®—æ³•ç»„åˆ | ä¼˜å…ˆä½¿ç”¨ `ECDHE` + `AES-GCM`ï¼Œç¦ç”¨ `RC4`ã€`DES`ã€`MD5` |
| **HSTS** | å¼ºåˆ¶ HTTPS | `max-age=63072000`ï¼ˆä¸¤å¹´ï¼‰ |
| **è¯ä¹¦æœ‰æ•ˆæœŸ** | SSL è¯ä¹¦è¿‡æœŸæ—¶é—´ | ä¸è¶…è¿‡ 397 å¤©ï¼ˆè¡Œä¸šè§„èŒƒï¼‰ |
| **OCSP Stapling** | è¯ä¹¦çŠ¶æ€æ£€æŸ¥ | å¯ç”¨ï¼Œæå‡æ€§èƒ½å’Œéšç§ |
| **Session Tickets** | ä¼šè¯æ¢å¤æœºåˆ¶ | ç¦ç”¨ï¼ˆå‰å‘å®‰å…¨è€ƒè™‘ï¼‰æˆ–å®šæœŸè½®æ¢å¯†é’¥ |

---

## 7. ç³»ç»Ÿæ•´åˆï¼šæ‰“é€ å®Œæ•´çš„ç½‘å…³æ¶æ„

ç°åœ¨ï¼Œæ˜¯æ—¶å€™æŠŠä¹‹å‰å­¦åˆ°çš„æ‰€æœ‰ç»„ä»¶æ•´åˆèµ·æ¥ï¼Œæ­å»ºä¸€ä¸ªå®Œæ•´çš„ç½‘å…³æ¶æ„äº†ã€‚

### 7.1 å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨/APPï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ HTTPS
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤–å±‚ï¼šCDN + WAF                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰                                                 â”‚   â”‚
â”‚  â”‚  - é™æ€èµ„æºç¼“å­˜ï¼ˆå›¾ç‰‡ã€CSSã€JSï¼‰                                      â”‚   â”‚
â”‚  â”‚  - å°±è¿‘è®¿é—®ï¼Œé™ä½å»¶è¿Ÿ                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰                                                â”‚   â”‚
â”‚  â”‚  - é˜²æŠ¤ SQL æ³¨å…¥ã€XSS æ”»å‡»                                            â”‚   â”‚
â”‚  â”‚  - æ‹¦æˆªæ¶æ„ Botã€çˆ¬è™«                                                 â”‚   â”‚
â”‚  â”‚  - CC æ”»å‡»é˜²æŠ¤ï¼ˆChallenge Collapsarï¼‰                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸­å±‚ï¼šAPI ç½‘å…³ï¼ˆNginx/Kongï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¬¬ä¸€å±‚ï¼šSSL ç»ˆç»“ + å®‰å…¨é˜²æŠ¤                                          â”‚   â”‚
â”‚  â”‚  - HTTPS / TLS 1.3                                                   â”‚   â”‚
â”‚  â”‚  - HSTSã€å®‰å…¨å“åº”å¤´                                                   â”‚   â”‚
â”‚  â”‚  - OCSP Stapling                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¬¬äºŒå±‚ï¼šè®¤è¯ä¸é‰´æƒ                                                    â”‚   â”‚
â”‚  â”‚  - JWT Token æ ¡éªŒ                                                    â”‚   â”‚
â”‚  â”‚  - OAuth 2.0 / SSO é›†æˆ                                               â”‚   â”‚
â”‚  â”‚  - API Key ç®¡ç†                                                       â”‚   â”‚
â”‚  â”‚  - æƒé™æ ¡éªŒï¼ˆRBACï¼‰                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¬¬ä¸‰å±‚ï¼šæµé‡æ§åˆ¶                                                      â”‚   â”‚
â”‚  â”‚  - é™æµï¼ˆRate Limitingï¼‰- ä»¤ç‰Œæ¡¶/æ¼æ¡¶ç®—æ³•                              â”‚   â”‚
â”‚  â”‚  - ç†”æ–­ï¼ˆCircuit Breakingï¼‰- é˜²æ­¢æ•…éšœæ‰©æ•£                               â”‚   â”‚
â”‚  â”‚  - é™çº§ï¼ˆDegradationï¼‰- æœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ                           â”‚   â”‚
â”‚  â”‚  - ç°åº¦å‘å¸ƒï¼ˆCanary Releaseï¼‰- æŒ‰æ¯”ä¾‹åˆ†é…æµé‡                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¬¬å››å±‚ï¼šè·¯ç”±ä¸è´Ÿè½½å‡è¡¡                                                 â”‚   â”‚
â”‚  â”‚  - è·¯å¾„è·¯ç”±ï¼ˆPath-based Routingï¼‰                                      â”‚   â”‚
â”‚  â”‚  - åŸŸåè·¯ç”±ï¼ˆHost-based Routingï¼‰                                      â”‚   â”‚
â”‚  â”‚  - Header è·¯ç”±ï¼ˆHeader-based Routingï¼‰                                 â”‚   â”‚
â”‚  â”‚  - è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢/åŠ æƒ/æœ€å°‘è¿æ¥/IP å“ˆå¸Œï¼‰                             â”‚   â”‚
â”‚  â”‚  - æœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰é›†æˆ                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¬¬äº”å±‚ï¼šåè®®è½¬æ¢ä¸æ•°æ®å¤„ç†                                             â”‚   â”‚
â”‚  â”‚  - SSL ç»ˆç»“ï¼ˆHTTPS â†” HTTPï¼‰                                           â”‚   â”‚
â”‚  â”‚  - åè®®è½¬æ¢ï¼ˆHTTP â†” gRPC / WebSocketï¼‰                                 â”‚   â”‚
â”‚  â”‚  - è¯·æ±‚/å“åº”è½¬æ¢ï¼ˆJSON â†” XMLï¼‰                                         â”‚   â”‚
â”‚  â”‚  - æ•°æ®å‹ç¼©ï¼ˆGzip / Brotliï¼‰                                           â”‚   â”‚
â”‚  â”‚  - ç¼“å­˜ï¼ˆCacheï¼‰- é™æ€èµ„æºå’Œ API å“åº”                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å†…å±‚ï¼šå¾®æœåŠ¡é›†ç¾¤                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚  â”‚  è®¢å•æœåŠ¡    â”‚  â”‚  å•†å“æœåŠ¡    â”‚  â”‚  æ”¯ä»˜æœåŠ¡    â”‚          â”‚
â”‚  â”‚  User Svc   â”‚  â”‚  Order Svc  â”‚  â”‚ Product Svc â”‚  â”‚ Payment Svc â”‚          â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚          â”‚
â”‚  â”‚  æœåŠ¡æ³¨å†Œ    â”‚  â”‚  æœåŠ¡æ³¨å†Œ    â”‚  â”‚  æœåŠ¡æ³¨å†Œ    â”‚  â”‚  æœåŠ¡æ³¨å†Œ    â”‚          â”‚
â”‚  â”‚   Consul    â”‚  â”‚   Consul    â”‚  â”‚   Consul    â”‚  â”‚   Consul    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                â”‚                â”‚                â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                       â”‚                                      â”‚
â”‚                    æœåŠ¡å‘ç°ä¸é…ç½®ä¸­å¿ƒï¼ˆConsul / etcdï¼‰                          â”‚
â”‚                    - æœåŠ¡æ³¨å†Œä¸å‘ç°                                            â”‚
â”‚                    - å¥åº·æ£€æŸ¥                                                  â”‚
â”‚                    - KV é…ç½®å­˜å‚¨                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å®æˆ˜ä»£ç æ¨¡æ¿ï¼šå®Œæ•´çš„ Nginx ç½‘å…³é…ç½®

```nginx
# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;  # è‡ªåŠ¨è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# åŠ è½½åŠ¨æ€æ¨¡å—ï¼ˆæ ¹æ®å®é™…éœ€è¦å¯ç”¨ï¼‰
# load_module modules/ngx_http_geoip2_module.so;

# å·¥ä½œæ¨¡å¼å’Œè¿æ¥æ•°ä¸Šé™
events {
    use epoll;  # Linux ä¸‹ä½¿ç”¨ epoll
    worker_connections 4096;  # æ¯ä¸ª Worker çš„æœ€å¤§è¿æ¥æ•°
    multi_accept on;  # å°½å¯èƒ½æ¥å—æ›´å¤šè¿æ¥
}

http {
    # åŸºç¡€è®¾ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # å®‰å…¨å“åº”å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼ˆå¯é€‰ï¼‰
    # add_header Content-Security-Policy "default-src 'self'; frame-ancestors 'self';" always;

    # ä¸Šæ¸¸æœåŠ¡å®šä¹‰
    # ç”¨æˆ·æœåŠ¡ï¼ˆåŠ æƒè½®è¯¢ï¼‰
    upstream user_service {
        server 10.0.1.10:8080 weight=3;
        server 10.0.1.11:8080 weight=2;
        keepalive 32;
    }

    # è®¢å•æœåŠ¡ï¼ˆæœ€å°‘è¿æ¥ï¼‰
    upstream order_service {
        least_conn;
        server 10.0.1.20:8080;
        server 10.0.1.21:8080;
        server 10.0.1.22:8080;
        keepalive 32;
    }

    # å•†å“æœåŠ¡ï¼ˆIP å“ˆå¸Œï¼Œä¼šè¯ä¿æŒï¼‰
    upstream product_service {
        ip_hash;
        server 10.0.1.30:8080;
        server 10.0.1.31:8080;
        keepalive 32;
    }

    # æ”¯ä»˜æœåŠ¡ï¼ˆä¸¥æ ¼çš„è´Ÿè½½å‡è¡¡ + å¥åº·æ£€æŸ¥ï¼‰
    upstream payment_service {
        server 10.0.1.40:8080 weight=2;
        server 10.0.1.41:8080 backup;  # å¤‡ä»½æœåŠ¡å™¨
        keepalive 32;
    }

    # é™æµåŒºåŸŸå®šä¹‰
    # æ™®é€š API é™æµï¼šæ¯ç§’ 10 è¯·æ±‚
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # ä¸¥æ ¼é™æµï¼šæ¯ç§’ 2 è¯·æ±‚ï¼ˆç”¨äºæ•æ„Ÿæ¥å£ï¼‰
    limit_req_zone $binary_remote_addr zone=strict_limit:10m rate=2r/s;

    # å…¨å±€é™æµï¼šä¿æŠ¤åç«¯æ•´ä½“
    limit_req_zone $server_name zone=global_limit:10m rate=100r/s;

    # è¿æ¥æ•°é™åˆ¶
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # è™šæ‹Ÿä¸»æœºé…ç½®
    server {
        listen 80;
        server_name api.example.com;

        # å¼ºåˆ¶ HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name api.example.com;

        # SSL é…ç½®ï¼ˆç•¥ï¼Œè§ä¸Šæ–‡ï¼‰
        ssl_certificate /etc/nginx/ssl/api.example.com.crt;
        ssl_certificate_key /etc/nginx/ssl/api.example.com.key;
        # ... å…¶ä»– SSL é…ç½®

        # å…¨å±€é™æµ
        limit_req zone=global_limit burst=200 nodelay;

        # ===== ç”¨æˆ·æœåŠ¡è·¯ç”± =====
        location /api/users/ {
            # åº”ç”¨é™æµ
            limit_req zone=api_limit burst=20 nodelay;
            limit_conn conn_limit 10;

            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;

            proxy_pass http://user_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # é”™è¯¯å¤„ç†
            proxy_intercept_errors on;
            error_page 500 502 503 504 /error.html;
        }

        # ===== è®¢å•æœåŠ¡è·¯ç”± =====
        location /api/orders/ {
            # æ›´ä¸¥æ ¼çš„é™æµ
            limit_req zone=strict_limit burst=10 nodelay;
            limit_conn conn_limit 5;

            proxy_pass http://order_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ===== å•†å“æœåŠ¡è·¯ç”± =====
        location /api/products/ {
            # ç¼“å­˜é™æ€èµ„æº
            location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
                expires 30d;
                add_header Cache-Control "public, immutable";
            }

            proxy_pass http://product_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ===== æ”¯ä»˜æœåŠ¡è·¯ç”±ï¼ˆæœ€é«˜å®‰å…¨çº§åˆ«ï¼‰ =====
        location /api/pay/ {
            # å¤šé‡é™æµä¿æŠ¤
            limit_req zone=strict_limit burst=5 nodelay;
            limit_req zone=global_limit burst=50 nodelay;
            limit_conn conn_limit 3;

            # åªå…è®¸å†…ç½‘è®¿é—®ï¼ˆé¢å¤–å®‰å…¨å±‚ï¼‰
            allow 10.0.0.0/8;
            allow 172.16.0.0/12;
            allow 192.168.0.0/16;
            deny all;

            # è¯¦ç»†æ—¥å¿—è®°å½•
            access_log /var/log/nginx/payment-access.log detailed;

            proxy_pass http://payment_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # æ”¯ä»˜æ¥å£å¢åŠ è¶…æ—¶æ—¶é—´
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # é”™è¯¯é¡µé¢
        location /error.html {
            internal;
            root /var/www/html;
        }

        # é™æµé”™è¯¯å¤„ç†
        error_page 429 /429.html;
        location = /429.html {
            internal;
            return 429 '{"error": "Too Many Requests", "message": "Rate limit exceeded. Please try again later."}';
            add_header Content-Type application/json;
        }
    }
}
```

### 7.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æœ€å¼ºï¼Ÿ

è¿™ä¸ªæ¶æ„çš„è®¾è®¡å“²å­¦ï¼Œæ˜¯ä¸ºäº†è§£å†³ä¸‰ä¸ªæ ¸å¿ƒçŸ›ç›¾ï¼š

**1. é«˜æ€§èƒ½ä¸é«˜å¯ç”¨ï¼ˆè´Ÿè½½å‡è¡¡ + å¥åº·æ£€æŸ¥ï¼‰**
- **çŸ›ç›¾**ï¼šå•å°æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œå®¹æ˜“æˆä¸ºç“¶é¢ˆï¼›å¤šå°æœåŠ¡å™¨éœ€è¦åè°ƒï¼Œé¿å…å•ç‚¹æ•…éšœã€‚
- **è§£æ³•**ï¼šä½¿ç”¨ Nginx ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ã€åŠ æƒã€æœ€å°‘è¿æ¥ã€IP å“ˆå¸Œï¼‰ã€‚é…åˆå¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹ï¼Œä¿è¯æœåŠ¡é«˜å¯ç”¨ã€‚

**2. å®‰å…¨æ€§ä¸æ˜“ç”¨æ€§ï¼ˆSSL ç»ˆç»“ + ç»Ÿä¸€è®¤è¯ï¼‰**
- **çŸ›ç›¾**ï¼šHTTPS ä¿è¯å®‰å…¨ï¼Œä½†é…ç½®å¤æ‚ã€è¯ä¹¦ç®¡ç†éº»çƒ¦ï¼›æ¯ä¸ªæœåŠ¡éƒ½è®¤è¯ï¼Œä»£ç é‡å¤ã€ç»´æŠ¤å›°éš¾ã€‚
- **è§£æ³•**ï¼šåœ¨ Nginx å±‚ç»Ÿä¸€åš SSL ç»ˆç»“å’Œè®¤è¯ã€‚å®¢æˆ·ç«¯åªéœ€ä¿¡ä»» Nginx çš„è¯ä¹¦ï¼Œåç«¯æœåŠ¡ä¹‹é—´ä½¿ç”¨ HTTP æ˜æ–‡é€šä¿¡ï¼Œç®€åŒ–é…ç½®ã€‚è®¤è¯é€»è¾‘ç»Ÿä¸€åœ¨ç½‘å…³å¤„ç†ï¼Œåç«¯æœåŠ¡ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚

**3. çµæ´»æ€§ä¸ç¨³å®šæ€§ï¼ˆé™æµç†”æ–­ + ç°åº¦å‘å¸ƒï¼‰**
- **çŸ›ç›¾**ï¼šæ–°åŠŸèƒ½éœ€è¦å¿«é€Ÿä¸Šçº¿éªŒè¯ï¼Œä½†å…¨é‡å‘å¸ƒé£é™©å¤§ï¼›çªå‘æµé‡å¯èƒ½å‹å®ç³»ç»Ÿï¼Œéœ€è¦ä¿æŠ¤æœºåˆ¶ã€‚
- **è§£æ³•**ï¼šä½¿ç”¨ Nginx çš„é™æµå’Œç†”æ–­åŠŸèƒ½ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«çªå‘æµé‡å‹å®ã€‚é…åˆç°åº¦å‘å¸ƒï¼ŒæŒ‰ Header æˆ–æ¯”ä¾‹å°†éƒ¨åˆ†æµé‡å¯¼åˆ°æ–°ç‰ˆæœ¬ï¼ŒéªŒè¯ç¨³å®šæ€§åå†å…¨é‡ä¸Šçº¿ã€‚

---

## 8. å®æˆ˜æ¨¡æ¿ï¼šç›´æ¥æŠ„ä½œä¸š

ä¸ºäº†è®©ä½ æ›´ç›´è§‚åœ°ç†è§£è¿™å¥—æœºåˆ¶æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Œæˆ‘ä»¬ä¸ºä½ å‡†å¤‡äº†**å…¨é“¾è·¯é…ç½®æ¨¡æ¿**ã€‚

### åœºæ™¯ 1ï¼šä¸­å°å‹ Web åº”ç”¨ï¼ˆå•åŸŸåï¼Œå¤šæœåŠ¡ï¼‰

> é€‚ç”¨åœºæ™¯ï¼šåˆ›ä¸šå…¬å¸å®˜ç½‘ + åå°ç®¡ç† + API æœåŠ¡

```nginx
# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    use epoll;
    worker_connections 4096;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml application/json application/javascript;

    # å®‰å…¨å“åº”å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ä¸Šæ¸¸æœåŠ¡
    upstream app_servers {
        server 127.0.0.1:3000;
        server 127.0.0.1:3001;
        keepalive 32;
    }

    upstream api_servers {
        server 127.0.0.1:4000;
        keepalive 32;
    }

    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;

    # HTTP æœåŠ¡å™¨
    server {
        listen 80;
        server_name example.com www.example.com;

        # å¼ºåˆ¶ HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼‰
        # return 301 https://$server_name$request_uri;

        # é™æ€æ–‡ä»¶
        location /static/ {
            alias /var/www/html/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        location /images/ {
            alias /var/www/html/images/;
            expires 90d;
            add_header Cache-Control "public, immutable";
        }

        # å‰ç«¯åº”ç”¨
        location / {
            limit_req zone=general burst=20 nodelay;

            proxy_pass http://app_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # API æ¥å£
        location /api/ {
            limit_req zone=api burst=40 nodelay;

            proxy_pass http://api_servers;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # HTTPS æœåŠ¡å™¨ï¼ˆç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼‰
    # server {
    #     listen 443 ssl http2;
    #     server_name example.com www.example.com;
    #
    #     ssl_certificate /etc/nginx/ssl/example.com.crt;
    #     ssl_certificate_key /etc/nginx/ssl/example.com.key;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    #     ssl_prefer_server_ciphers off;
    #     ssl_session_cache shared:SSL:50m;
    #     ssl_session_timeout 1d;
    #
    #     # å¤åˆ¶ HTTP æœåŠ¡å™¨çš„ location é…ç½®
    #     # ...
    # }
}
```

### åœºæ™¯ 2ï¼šå¾®æœåŠ¡æ¶æ„ï¼ˆå¤šåŸŸåï¼Œå¤æ‚è·¯ç”±ï¼‰

> é€‚ç”¨åœºæ™¯ï¼šå¤§å‹äº’è”ç½‘å…¬å¸ï¼Œå¤šä¸šåŠ¡çº¿ï¼Œå¤šå›¢é˜Ÿåä½œ

```nginx
# å¾®æœåŠ¡æ¶æ„ä¸‹çš„ Nginx é…ç½®ç¤ºä¾‹
# ç‰¹ç‚¹ï¼šå¤šåŸŸåã€å¤æ‚è·¯ç”±ã€æœåŠ¡å‘ç°é›†æˆ

# æœåŠ¡å‘ç°é›†æˆï¼ˆä½¿ç”¨ Consul æˆ– etcdï¼‰
# éœ€è¦ nginx-upsync-module æ¨¡å—
upstream user_service {
    # ä» Consul è‡ªåŠ¨å‘ç°æœåŠ¡å®ä¾‹
    upsync 127.0.0.1:8500/v1/catalog/service/user-service upsync_timeout=6m upsync_interval=500ms;
    upsync_dump_path /var/nginx/conf/user_service.conf;

    # é»˜è®¤æœåŠ¡å™¨ï¼ˆConsul ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
    server 127.0.0.1:11111 down;

    keepalive 64;
    keepalive_timeout 60s;
    keepalive_requests 1000;
}

# åŠ¨æ€ upstream ç¤ºä¾‹ï¼ˆLua + Redisï¼‰
upstream dynamic_backend {
    server 0.0.0.0;  # å ä½ç¬¦

    balancer_by_lua_block {
        local balancer = require "ngx.balancer"
        local resty_redis = require "resty.redis"

        -- ä» Redis è·å–å¯ç”¨åç«¯åˆ—è¡¨
        local redis = resty_redis:new()
        redis:connect("127.0.0.1", 6379)

        local backends, err = redis:smembers("backends:available")
        if not backends or #backends == 0 then
            ngx.log(ngx.ERR, "no available backends")
            return ngx.exit(503)
        end

        -- ç®€å•çš„è½®è¯¢é€‰æ‹©
        local hash = ngx.var.remote_addr .. ngx.var.request_uri
        local index = ngx.crc32_short(hash) % #backends + 1
        local selected = backends[index]

        -- è®¾ç½®åç«¯åœ°å€
        local ok, err = balancer.set_current_peer(selected, 80)
        if not ok then
            ngx.log(ngx.ERR, "failed to set peer: ", err)
            return ngx.exit(500)
        end
    }
}

# åŸºäº Host çš„å¤šåŸŸåè·¯ç”±
server {
    listen 80;
    server_name api.user.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.user.example.com;

    ssl_certificate /etc/nginx/ssl/user.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/user.example.com.key;

    # JWT è®¤è¯ï¼ˆä½¿ç”¨ Luaï¼‰
    access_by_lua_block {
        local jwt = require "resty.jwt"

        local auth_header = ngx.var.http_authorization
        if not auth_header then
            ngx.exit(401)
        end

        local token = auth_header:match("^Bearer%s+(.+)$")
        if not token then
            ngx.exit(401)
        end

        local jwt_obj = jwt:verify(os.getenv("JWT_SECRET"), token)
        if not jwt_obj.verified then
            ngx.exit(401)
        end

        -- å°†ç”¨æˆ·ä¿¡æ¯è®¾ç½®åˆ°å˜é‡
        ngx.var.user_id = jwt_obj.payload.sub
        ngx.var.user_role = jwt_obj.payload.role
    }

    location / {
        # æƒé™æ§åˆ¶
        if ($user_role != "user" && $user_role != "admin") {
            return 403;
        }

        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Admin APIï¼ˆç®¡ç†åå°ï¼Œæ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼‰
server {
    listen 443 ssl http2;
    server_name api.admin.example.com;

    ssl_certificate /etc/nginx/ssl/admin.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/admin.example.com.key;

    # IP ç™½åå•ï¼ˆåªå…è®¸å…¬å¸å†…ç½‘è®¿é—®ï¼‰
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;

    # ä¸¥æ ¼çš„é™æµ
    limit_req zone=strict_limit burst=5 nodelay;
    limit_conn conn_limit 5;

    # åªå…è®¸ç®¡ç†å‘˜è§’è‰²è®¿é—®
    set $admin_required 1;

    location / {
        if ($user_role != "admin") {
            return 403;
        }

        proxy_pass http://admin_service;
        proxy_set_header Host $host;
        proxy_set_header X-User-ID $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 9. åè¯å¯¹ç…§è¡¨

| è‹±æ–‡æœ¯è¯­ | ä¸­æ–‡å¯¹ç…§ | è§£é‡Š |
| :--- | :--- | :--- |
| **Reverse Proxy** | åå‘ä»£ç† | éƒ¨ç½²åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚å¹¶è½¬å‘ç»™å†…éƒ¨æœåŠ¡å™¨çš„ä»£ç†æœåŠ¡ã€‚å®¢æˆ·ç«¯åªçŸ¥é“åå‘ä»£ç†çš„å­˜åœ¨ï¼Œä¸çŸ¥é“çœŸå®æœåŠ¡å™¨åœ°å€ã€‚ |
| **Forward Proxy** | æ­£å‘ä»£ç† | éƒ¨ç½²åœ¨å®¢æˆ·ç«¯ä¾§ï¼Œä»£æ›¿å®¢æˆ·ç«¯è®¿é—®å¤–éƒ¨èµ„æºçš„ä»£ç†æœåŠ¡ã€‚æœåŠ¡ç«¯çœ‹åˆ°çš„æ˜¯ä»£ç†çš„ IPï¼Œä¸çŸ¥é“çœŸå®å®¢æˆ·ç«¯ã€‚å…¸å‹åº”ç”¨ï¼šVPNã€ç¿»å¢™å·¥å…·ã€‚ |
| **API Gateway** | API ç½‘å…³ | ä½äºå®¢æˆ·ç«¯å’Œåç«¯æœåŠ¡ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œæä¾›è·¯ç”±ã€è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰åŠŸèƒ½ï¼Œæ˜¯å¾®æœåŠ¡æ¶æ„çš„"ç»Ÿä¸€å¤§é—¨"ã€‚ |
| **Load Balancing** | è´Ÿè½½å‡è¡¡ | å°†è¯·æ±‚æµé‡åˆ†é…åˆ°å¤šå°æœåŠ¡å™¨ï¼Œé¿å…å•å°æœåŠ¡å™¨è¿‡è½½ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§å’Œæ€§èƒ½ã€‚ |
| **Rate Limiting** | é™æµ | é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«çªå‘æµé‡å‹å®ã€‚å¸¸ç”¨ç®—æ³•ï¼šä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€æ»‘åŠ¨çª—å£ã€‚ |
| **Circuit Breaking** | ç†”æ–­ | å½“ä¾èµ–æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ–­è°ƒç”¨ï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œå¹¶æä¾›é™çº§æ–¹æ¡ˆã€‚ |
| **SSL Termination** | SSL ç»ˆç»“ | åœ¨ç½‘å…³å±‚å¤„ç† HTTPS åŠ å¯†è§£å¯†ï¼Œåç«¯æœåŠ¡ä½¿ç”¨ HTTPï¼Œé™ä½åç«¯è®¡ç®—å¼€é”€ï¼Œç®€åŒ–è¯ä¹¦ç®¡ç†ã€‚ |
| **Health Check** | å¥åº·æ£€æŸ¥ | å®šæœŸæ£€æŸ¥åç«¯æœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹ï¼Œä¿è¯æµé‡åªå‘é€åˆ°å¥åº·çš„æœåŠ¡å®ä¾‹ã€‚ |
| **Sticky Session** | ä¼šè¯ä¿æŒ | å°†åŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚å§‹ç»ˆè·¯ç”±åˆ°åŒä¸€å°åç«¯æœåŠ¡å™¨ï¼Œç”¨äºéœ€è¦ä¿æŒä¼šè¯çŠ¶æ€çš„åœºæ™¯ã€‚ |
| **Blue-Green Deployment** | è“ç»¿éƒ¨ç½² | åŒæ—¶è¿è¡Œä¸¤ä¸ªç”Ÿäº§ç¯å¢ƒï¼ˆè“ã€ç»¿ï¼‰ï¼Œåˆ‡æ¢æµé‡å®ç°é›¶åœæœºå‘å¸ƒã€‚ |
| **Canary Release** | ç°åº¦å‘å¸ƒ | å°†å°‘é‡æµé‡å¯¼åˆ°æ–°ç‰ˆæœ¬ï¼ŒéªŒè¯ç¨³å®šæ€§åé€æ­¥æ‰©å¤§æ¯”ä¾‹ï¼Œé™ä½å‘å¸ƒé£é™©ã€‚ |
| **Upstream** | ä¸Šæ¸¸ | åœ¨ Nginx é…ç½®ä¸­ï¼ŒæŒ‡ä»£åç«¯æœåŠ¡å™¨ç»„ã€‚ |
| **Location** | ä½ç½®å— | Nginx ä¸­ç”¨äºåŒ¹é…è¯·æ±‚ URL å¹¶å®šä¹‰å¤„ç†è§„åˆ™çš„é…ç½®å—ã€‚ |
| **Worker Process** | å·¥ä½œè¿›ç¨‹ | Nginx ä¸­å®é™…å¤„ç†è¯·æ±‚çš„è¿›ç¨‹ï¼Œå¤šä¸ª Worker å¹¶è¡Œå·¥ä½œï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚ |
| **Master Process** | ä¸»è¿›ç¨‹ | Nginx ä¸­è´Ÿè´£ç®¡ç† Worker è¿›ç¨‹ï¼ˆå¯åŠ¨ã€åœæ­¢ã€é‡æ–°åŠ è½½é…ç½®ï¼‰çš„æ§åˆ¶è¿›ç¨‹ã€‚ |
| **Event-Driven** | äº‹ä»¶é©±åŠ¨ | ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œé€šè¿‡ç›‘å¬å’Œå“åº”äº‹ä»¶ï¼ˆå¦‚ I/O å°±ç»ªï¼‰æ¥å¤„ç†å¹¶å‘ï¼ŒNginx çš„æ ¸å¿ƒæ¶æ„ã€‚ |
| **epoll / kqueue** | I/O å¤šè·¯å¤ç”¨ | Linux/macOS ä¸‹çš„é«˜æ€§èƒ½ I/O äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå…è®¸å•ä¸ªè¿›ç¨‹åŒæ—¶å¤„ç†å¤§é‡è¿æ¥ã€‚ |

---

## æ€»ç»“ï¼šåå‘ä»£ç†ä¸ç½‘å…³çš„æœ¬è´¨

ç»è¿‡è¿™ä¸€ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå‡ ä¸ªæ ¸å¿ƒç»“è®ºï¼š

**ä»å®è·µæ¥çœ‹**ï¼š
- åå‘ä»£ç†è§£å†³çš„æ˜¯"æµé‡æ€ä¹ˆåˆ†å‘"çš„é—®é¢˜ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ã€ä¼šè¯ä¿æŒç­‰æœºåˆ¶ï¼Œå°†æµé‡é«˜æ•ˆã€å¯é åœ°é€è¾¾åç«¯æœåŠ¡ã€‚
- API ç½‘å…³è§£å†³çš„æ˜¯"è¯·æ±‚æ€ä¹ˆå¤„ç†"çš„é—®é¢˜ï¼Œåœ¨ç»Ÿä¸€çš„å…¥å£ç‚¹å¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆè®¤è¯ã€é™æµã€æ—¥å¿—ç­‰ï¼‰ï¼Œè®©åç«¯æœåŠ¡ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚

**ä»æ¶æ„è§†è§’çœ‹**ï¼š
- ç½‘å…³æ˜¯ç³»ç»Ÿçš„"é—¨é¢"ï¼Œæ‰€æœ‰æµé‡éƒ½ç»è¿‡è¿™é‡Œï¼Œæ˜¯å®‰å…¨é˜²æŠ¤çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®èŠ‚ç‚¹ã€‚
- åˆç†çš„ç½‘å…³æ¶æ„ï¼Œå¯ä»¥å°†å•å°æœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›æ‰©å±•åˆ°æ•´ä¸ªé›†ç¾¤ï¼Œå°†å•ç‚¹æ•…éšœé£é™©åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œå°†å¤æ‚çš„å®‰å…¨ç­–ç•¥æ”¶æ•›åˆ°ç»Ÿä¸€å…¥å£ã€‚

**ä»è¿ç»´è§†è§’çœ‹**ï¼š
- è¯ä¹¦ç®¡ç†ã€é™æµç­–ç•¥ã€è·¯ç”±è§„åˆ™ï¼Œéƒ½åº”è¯¥åœ¨ç½‘å…³å±‚ç»Ÿä¸€é…ç½®ï¼Œé¿å…åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ã€‚
- ç›‘æ§å’Œæ—¥å¿—ä¹Ÿåº”è¯¥åœ¨ç½‘å…³å±‚ç»Ÿä¸€æ”¶é›†ï¼Œä¾¿äºåˆ†ææµé‡æ¨¡å¼ã€æ’æŸ¥é—®é¢˜ã€å®¡è®¡å®‰å…¨äº‹ä»¶ã€‚

ç›®æ ‡æ˜¯ï¼šåœ¨ç»™å®šçš„èµ„æºå’Œæ€§èƒ½çº¦æŸä¸‹ï¼Œè®©æ¯ä¸€æ¬¡è¯·æ±‚éƒ½èƒ½è¢«å®‰å…¨ã€é«˜æ•ˆã€å¯é åœ°å¤„ç†ã€‚